---
title: "FOI_changed_ every 5 years_ data 2013-2017"
author: "Phuong Huynh Thi"
date: "5 September 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r set wd, echo=FALSE, message=FALSE}

setwd("/home/phuonght/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/FOI")

# library(plyr)
# library(caret)
# library(lattice)
# library(ggplot2)
# library(nnet)last
# library(psych)
# library(data.table)

##result from lowest AIC model:
data <- read.csv("~/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/models_modified_titers/Infecting serotype Models/PredictedIS_batch567_pred.serotype.csv")

data$YEAR <- as.factor(data$YEAR)
data$predictedIS<- ordered(data$predictedIS,levels=c("Secondary","Primary","Neg"))
data$pred.serotype<- as.factor(data$pred.serotype)

## result from lowest AIC model and homotypic responses were assigned the serotype in advance of applying infecting model
# data <- read.csv("~/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/models_modified_titers/Infecting serotype Models/PredictedIS_batch567_pred.serotype_HomoAssigned.csv")

pop<- data[which(!is.na(data$AGE_MIN)&is.na(data$PanbioUnit)),]# cross out acute and ELISA samples
pop$Site <- substr(pop$sampleID,1,2)

#Agegroup_ 1year
pop$AgeGroup <-factor(as.factor(floor(pop$Age)),labels=c("[1-2)","[2-3)","[3-4)","[4-5)","[5-6)","[6-7)","[7-8)","[8-9)","[9-10)","[10-11)","[11-12)","[12-13)","[13-14)","[14-15)","[15-16)","[16-17)","[17-18)","[18-19)","[19-20)","[20-21)","[21-22)","[22-23)","[23-24)","[24-25)","[25-26)","[26-27)","[27-28)","[28-29)","[29-30)","[30,31)"))# group as  1year 1 group.

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
## Agegroup_ 2 years : 16groups

# pop$AgeGroup <-factor(as.factor(floor(pop$Age/2)+1),labels=c("[1-2)","[2-4)","[4-6)","[6-8)","[8-10)","[10-12)","[12-14)","[14-16)","[16-18)","[18-20)","[20-22)","[22-24)","[24-26)","[26-28)","[28-30)","[30-31)"))

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
##Agegroup_3years : 11 groups

# pop$AgeGroup <- floor(pop$Age/3) + 1
# pop$AgeGroup[which(pop$AgeGroup == 11)] <- 10
# pop$AgeGroup <- factor(
#   pop$AgeGroup,
#   labels = c("[1-3)","[3-6)","[6-9)","[9-12)","[12-15)","[15-18)",
#              "[18-21)","[21-24)","[24-27)","[27-31)"))


```

# Model 
First do for one location for one year and get that working
**For each age:** 

Numbers of samples:

Number of neg samples:

Numbers of samples classified as primary:

Number of samples classified as secondary:

```{r data input KH or HC , echo=FALSE, message=FALSE}

library(dplyr)
library(tidyr)
# spread(x,y): spread rows of col x into collums, then value of col y will fit in as rows.
#rename(new_name=old_name).

p_year=dplyr::filter(pop,Site=="KH")%>%group_by(AgeGroup,YEAR,Site)%>%dplyr::count(predictedIS)%>%spread(predictedIS,n)
p_year$total <- apply(p_year[,4:6],1,sum,na.rm=T)
p_year <- p_year[order(p_year$YEAR),]


#create function for substr age rather than put age in order, this is useful in case of missing data in a specific age: 
my_substr <- function(s){
  if (nchar(s) == 5){
    t <- substr(s, 4, 4)
  }else{
    if (nchar(s) == 6){
      t <- substr(s, 4, 5)
    }else{
      t <- substr(s, 5, 6)
    }
  }
  return(t)
}

#
p_year$age<- apply(p_year[,1],1,my_substr)

# Assign NA as 0 because stan does not support NA value:

for (idx in 4:6){
  idx.na <- which(is.na(p_year[[idx]]))
  p_year[[idx]][idx.na] <- 0
}


# setnames(p_year, old=c("AgeGroup","1","2","3","4","Neg","Secondary","total"),new=c("AgeGroup","DV1.13","DV2.13","DV3.13","DV4.13","Neg.13","Sec.13","total.13"))


```

## Data input

For each year in the past up to age a:FOI, in the following code this assumed to be equal across serotypes.

This gets the data in the right format for stan.

```{r data format for stan, echo=FALSE, message=FALSE}

b = length(p_year$age)

# number of years: HC: 34 yrs, KH: 35 yrs
n_y <- 2017-2013+max(as.integer(p_year[which(p_year$YEAR==2013),]$age))

l_vecj = length(c(rep(1:round(n_y/5), each =  5)))

datapp<- list(a = b,
              
              datap=c(p_year[1:b,6],
                      p_year[1:b,5],
                      p_year[1:b,4]),
              vecj = as.integer(c(rep(1:round(n_y/5), each =  5))),#for index of actual lambda
              l_vecj = length(c(rep(1:round(n_y/5), each =  5))),# length of vecj for later use
              vecy = as.integer(as.character(p_year$YEAR)),
              veca = as.integer(p_year$age)) # numbers of neg, prim,and sec respectively. 

library(rstan)
# index year: 
#2013: 1:23 / 23
#2014: 24:49 / 26
#2015: 50:76 / 27
#2016: 77:101 / 25
#2017:102:125 / 24

# stan code has sections in it: functions, data (where you tell it what form the data will be in), 
#parameters where you say what parameters you are estimating,
#Transformed parameters where you transform these parameters to use in the model
#and the model where you specify how the data and model outcomes are linked


```

## Model code

```{r model code, echo=FALSE, message=FALSE}
FOI_Dengue <- "

//write function so we can sum things as sum is not built into stan

data {

// HCMC infections
int<lower=0> a;// number of age groups

int<lower=0> l_vecj;

int veca[a]; //vector age constitute of specific age rather than ages in order.

int vecy[a]; //vector year

int vecj[l_vecj];// vector vecj comprises integer value => for index of lambda
 
int datap[3,a]; ////for 2013 this will be three groups (primary, secondary and negative for all age groups)



}

parameters {

vector<lower=0,upper=1>[l_vecj/5] lambda; // 2017-2013+max(age of 2013): 34/2=17 years HC, KH: 35/2=18 yrs

}

transformed parameters {
//the probabilities of being neg, primary and secondary at each age group 
////// HCMC
// need to specify what type of data and how these are...

real pneg[a];// the probabilities of neg at each age group and year
real pprimsero[a] ; // the probabilities of primary infection of each serotype at each age group and year
real psec[a];// the probabilities of each secondary infection at each age group and year

// calculating all these probabilities
for ( ar in 1:a){

pneg[ar]=exp(-sum(lambda[vecj[(2017-vecy[ar]+1):(2017-vecy[ar]+veca[ar])]])*4);

pprimsero[ar]=4*exp(-sum(lambda[vecj[(2017-vecy[ar]+1):(2017-vecy[ar]+veca[ar])]])*3)*( 1- exp(-sum(lambda[vecj[(2017-vecy[ar]+1):(2017-vecy[ar]+veca[ar])]])));

psec[ar]= 1-pneg[ar]-pprimsero[ar];

}
}


model {
//vector to put the model results in
vector[3] vp;

//prior on the parameter we are estimating
lambda~ beta(2,5); 

// the estimates of the things we have data for given the proportions above.

for (ar in 1:a){
vp[1]=pneg[ar];
vp[2]=pprimsero[ar];
vp[3]=psec[ar];
//likelihood thing assume multinomial
datap[1:3, ar]  ~  multinomial(vp) ;
}
}
"

```

Stan does not support NA in data? => Assign NA as 0

**Some explanation**

Rhat: < 1.05: model perform well
n-eff ratio = n-eff/(0.5 * iter * chains) <1
Iterations: 1/2 Warmup : noise data=> exclude?!, 1/2 Sampling

Posterior distribution (likelihood function= model  and prior distribution: e.g: lamda[0,1] ).

```{r result from model, echo=FALSE, include=FALSE,message=FALSE}
# you then run using this: From this output we can quickly assess model convergence by looking at the Rhat values for each parameter. When these are at or near 1, the chains have converged. There are many other diagnostics, but this is an important one for Stan.
# stan_model_exp <- stan_model(FOI_Dengue_a)
fit<-stan(model_code=FOI_Dengue, data=datapp, iter=6000,chains=4, cores = parallel::detectCores())
#extract parameters so we can use them as below

posterior<-rstan::extract(fit) # specify package rstan rather tham tidyr
#this summarizes the parameters, gets mean,etc. of parameters and metrics of whether converged or not like Rhat and neff
foisummary<-summary(fit)
# print(foisummary)

```

# Visualise the model result

## Traceplot of estimating parameter: lambda


```{r trace plot visualize,echo=FALSE, fig.height=8, fig.width=12}

# plot to see whether estimated parameter is convergence or not: traceplot
# plottedRows <- 1 : nrow(posterior$lambda)
# plottedRows <- which(plottedRows %% 6 == 0)
# plot(posterior$lambda[plottedRows, 7],type="l")

stan_trace(fit, pars="lambda", inc_warmup = F)


# stan_plot(fit,pars = c("pneg","psec"),point_est = "median",show_density = FALSE,ci_level = 0.8, outer_level = 0.95,show_outer_line = TRUE, fill_color = "maroon")
# 
# stan_scat(fit,pars = "lambda")
# 
# stan_hist(fit,pars = "lambda")
# 
# stan_dens(fit,pars = "lambda",separate_chains = T)
# 
# stan_ac(fit,pars = "lambda", separate_chains = T)
# 
# stan_trace(fit,pars = "lambda")


```

# Ploting the result of model and actual data

## Plot the posterior distribution

```{r posterior distribution of lambda, echo=FALSE,fig.height=8,fig.width=12}
#plot the posterior distribution of lambda

#create dataframe for violin plot:
p <- data.frame(lambda = as.numeric(),
                YEAR = as.character()) 

for(a in 1:(l_vecj/5)){
  p_temp <- data.frame(lambda = posterior$lambda[ ,a],
                       YEAR = paste0(2018-(5*(a-1)+1)))
  p <- rbind(p, p_temp)
}

p$YEAR <- factor(p$YEAR,labels = c ("2017-2013","2012-2008","2007-2003","2002-1998","1997-1993","1992-1988","1987-1983"))

# violin plot
ggplot(p, aes(x=YEAR,y=lambda)) + geom_violin()+
  ggtitle(paste("posterior lambda _ change every 5 years in",p_year$Site[1]))+
    ylim(-0.01,0.15)+
  theme(plot.title = element_text(hjust=0.5,face="bold",size=20,colour = "blue"),
        axis.title.x = element_blank(),
        axis.text = element_text(face = "bold", angle = 45, hjust = 1))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl, 
               geom="pointrange", color="red")#Add mean and standard deviation


```


```{r seroprevalane accumulation 2017,echo=FALSE, fig.height=8, fig.width=12}

#create function for substr age rather than put age in order, this is useful in case of missing data in a specific age: 
my_substr <- function(s){
  s <- as.character(s)
  if (nchar(s) == 5){
    t <- substr(s, 4, 4)
  }else{
    if (nchar(s) == 6){
      t <- substr(s, 4, 5)
    }else{
      t <- substr(s, 5, 6)
    }
  }
  return(t)
}

pop_2017<- pop
pop_2017$age <- sapply(pop_2017[,36],my_substr)
pop_2017$age.17 <- NA

pop_2017$YEAR <- as.numeric(as.character(pop_2017$YEAR))
pop_2017$age <- as.numeric(as.character(pop_2017$age))

for ( i in 1: length(pop_2017$AgeGroup)){
  
  pop_2017$age.17[i] <- pop_2017$age[i] + (2017- pop_2017$YEAR[i])
}




# plot
library(dplyr)
library(grDevices)
# d.17=dplyr::filter(pop_2017,Site=="KH")%>%group_by(age.17,Site,cutoff_5) %>% dplyr::count(age.17)

d.17=dplyr::group_by(pop_2017,age.17,Site,cutoff_5) %>% dplyr::count(age.17)


# Plot in KH
ggplot(d.17%>% filter(Site=="KH"),aes(x=age.17,y=n,fill=cutoff_5))+
  geom_bar(position="fill",stat="identity")+
  # scale_fill_manual(values = c("blue","chocolate3","burlywood3","cornsilk4","azure3","light blue"))+
  # scale_fill_brewer(palette="Spectral")+
  ggtitle("DENV seroprevalence in KH _ 2013-2017")+
  # facet_grid(~YEAR)+
  labs(y="Proportion")+
  scale_x_continuous( breaks = seq(1:35), limits = c (1,36))+
  theme(plot.title =element_text(hjust = 0.5,size=20,face="bold"),
        title=element_text(size=15),
        strip.text.x = element_text(size=18),
        axis.text.x = element_text(angle = 90, size=12,face = "bold"),
        axis.text.y=element_text(size=15, face="bold"),
        axis.title.x = element_blank())


# Plot in HC

ggplot(d.17%>% filter(Site=="HC"),aes(x=age.17,y=n,fill=cutoff_5))+
  geom_bar(position="fill",stat="identity")+
  # scale_fill_manual(values = c("blue","chocolate3","burlywood3","cornsilk4","azure3","light blue"))+
  # scale_fill_brewer(palette="Spectral")+
  ggtitle("DENV seroprevalence in HC _ 2013-2017")+
  # facet_grid(~YEAR)+
  labs(y="Proportion")+
  scale_x_continuous(breaks = seq(1:35), limits = c (1,36))+
  theme(plot.title =element_text(hjust = 0.5,size=20,face="bold"),
        title=element_text(size=15),
        strip.text.x = element_text(size=18),
        axis.text.x = element_text(angle = 90, size=12,face = "bold"),
        axis.text.y=element_text(size=15, face="bold"),
        axis.title.x = element_blank())


```



```{r  posterior distribution of neg proportion,echo=FALSE, message=FALSE,fig.height=8,fig.width=12, warning=FALSE}

p_all_year <- data.frame(neg = as.numeric(),
                         age = as.character(),
                         year= as.character())


for(a in 1:b){
  p_temp <- data.frame(neg = posterior$pneg[ , a],
                       age = paste0(p_year$age[a]),
                       year= paste0(p_year$YEAR[a]))
  p_all_year <- rbind(p_all_year, p_temp)
}

# relable factor level of age in order
p_all_year$age <- as.numeric(as.character(p_all_year$age))
p_all_year <- p_all_year[order(p_all_year$age),]
p_all_year$age <- as.factor(p_all_year$age)

library(gridExtra)
library(grid)


list_year <- unique(p_all_year$year)
for (idx.year in 1 : length(list_year)){
  p <- dplyr::filter(p_all_year,year==list_year[idx.year]) # extract data for each year
  
  # length of data frame
  x_max <- length(p$age)
  
  # violin plot
  list.plot <- list()
  
  for (i in 1 : 6){# seperate 6 graphs for each year
    list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=neg)) +
      geom_violin()+
      theme(plot.subtitle = element_text(hjust=0.5),
            axis.title = element_blank(),
            axis.text = element_text(face = "bold"))+
      # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
      # geom_boxplot(width=0.1)+# add median and quartile
      stat_summary(fun.data=mean_sdl,
                   geom="pointrange", color="red")+#Add mean and sta
      coord_cartesian(ylim=c(0, 1))
  }
  
  
  
  grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of neg_ FOI changed every year",p_year$Site[1],p$year[1]),gp=gpar(fontsize=25,col = "blue")))
  
}



```


```{r  posterior distribution of primary proportion,echo=FALSE, message=FALSE,fig.height=8,fig.width=12, warning=FALSE}

p_all_year <- data.frame(prim = as.numeric(),
                         age = as.character(),
                         year= as.character())


for(a in 1:b){
  p_temp <- data.frame(prim = posterior$pprimsero[ , a],
                       age = paste0(p_year$age[a]),
                       year= paste0(p_year$YEAR[a]))
  p_all_year <- rbind(p_all_year, p_temp)
}

# relable factor level of age in order
p_all_year$age <- as.numeric(as.character(p_all_year$age))
p_all_year <- p_all_year[order(p_all_year$age),]
p_all_year$age <- as.factor(p_all_year$age)

library(gridExtra)
library(grid)


list_year <- unique(p_all_year$year)
for (idx.year in 1 : length(list_year)){
  p <- dplyr::filter(p_all_year,year==list_year[idx.year]) # extract data for each year
  
  # length of data frame
  x_max <- length(p$age)
  
  # violin plot
  list.plot <- list()
  
  for (i in 1 : 6){# seperate 6 graphs for each year
    list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=prim)) +
      geom_violin()+
      theme(plot.subtitle = element_text(hjust=0.5),
            axis.title = element_blank(),
            axis.text = element_text(face = "bold"))+
      # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
      # geom_boxplot(width=0.1)+# add median and quartile
      stat_summary(fun.data=mean_sdl,
                   geom="pointrange", color="red")+#Add mean and sta
      coord_cartesian(ylim=c(0, 1))
  }
  
  
  
  grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of primary_ FOI changed every year",p_year$Site[1],p$year[1]),gp=gpar(fontsize=25,col = "blue")))
  
}



```



```{r  posterior distribution of secondary proportion,echo=FALSE, message=FALSE,fig.height=8,fig.width=12, warning=FALSE}

p_all_year <- data.frame(sec = as.numeric(),
                         age = as.character(),
                         year= as.character())


for(a in 1:b){
  p_temp <- data.frame(sec = posterior$psec[ , a],
                       age = paste0(p_year$age[a]),
                       year= paste0(p_year$YEAR[a]))
  p_all_year <- rbind(p_all_year, p_temp)
}

# relable factor level of age in order
p_all_year$age <- as.numeric(as.character(p_all_year$age))
p_all_year <- p_all_year[order(p_all_year$age),]
p_all_year$age <- as.factor(p_all_year$age)

library(gridExtra)
library(grid)


list_year <- unique(p_all_year$year)
for (idx.year in 1 : length(list_year)){
  p <- dplyr::filter(p_all_year,year==list_year[idx.year]) # extract data for each year
  
  # length of data frame
  x_max <- length(p$age)
  
  # violin plot
  list.plot <- list()
  
  for (i in 1 : 6){# seperate 6 graphs for each year
    list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),],   aes(x=age,y=sec)) +
      geom_violin()+
      theme(plot.subtitle = element_text(hjust=0.5),
            axis.title = element_blank(),
            axis.text = element_text(face = "bold"))+
      # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
      # geom_boxplot(width=0.1)+# add median and quartile
      stat_summary(fun.data=mean_sdl,
                   geom="pointrange", color="red")+#Add mean and sta
      coord_cartesian(ylim=c(0, 1))
  }
  
  
  
  grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of secondary_ FOI changed every year",p_year$Site[1],p$year[1]),gp=gpar(fontsize=25,col = "blue")))
  
}


```




## Plot the estimated proportion within 95% CI


```{r estimated proportion, echo=FALSE, message=FALSE,fig.height=8,fig.width=12}

pest.all<-data.frame(foisummary$summary)
l_pest.all = length(pest.all$mean) # last row og pest.all
d = (l_pest.all -round(l_vecj/5) - 1)/3 # 3 group: neg,prim,sec

pest.all<- pest.all[-c(1:round(l_vecj/5),l_pest.all),] # n_y: number of lamda
pest.all$IS <- rep(c("Neg_est","Prim_est","Second_est"),c(d,d,d))
pest.all$AgeGroup<- as.integer(rep(p_year$age,3))
pest.all$YEAR<- as.integer(rep(as.character(p_year$YEAR),3))
# pest.all$year<- as.factor(pest.all$year)
# function to get legend from one of the plots => for nicer looking of muliplot 
get_legend<-function(myggplot){
    tmp <- ggplot_gtable(ggplot_build(myggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
}

#plot

list_year<- unique(pest.all$YEAR)
pp <- list()
for (idx.year in (1 : length(list_year)) ){
    
    pest <- dplyr::filter(pest.all,YEAR==list_year[idx.year])
    
    pp[[idx.year]] <- ggplot(pest,aes(x=AgeGroup,y=mean, fill=IS,color=IS))+ geom_line()+
              geom_ribbon(aes(ymin=X2.5., ymax = X97.5.),alpha=0.2)+
              ggtitle(paste(pest$YEAR[1]))+
              xlim(1,31)+
              ylim(0,1)+
              # scale_x_continuous(limits = c(1,31))+
              # scale_y_continuous((limits = c(0,1)))+
              theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
                    axis.text = element_text(face = "bold"),
                    axis.title.y = element_blank())
    
}

legend <- get_legend(pp[[5]])

library(grid)
library(gridExtra)
grid.arrange(pp[[1]]+theme(legend.position = "none"),
             pp[[2]]+theme(legend.position = "none"),
             pp[[3]]+theme(legend.position = "none"),
             pp[[4]]+theme(legend.position = "none"),
             pp[[5]]+theme(legend.position = "none"),
             legend, nrow=3,ncol=2,
             bottom = textGrob(paste(" Estimated DENV proportion in",p_year$Site, "_FoI change every 5 years "),gp=gpar(fontsize=20,fontface="bold"))) # all plot in one page 


# # plot grid line:by aLam
# 
# library(devtools)
# install_github("lamhm/RUtil")
# library(RUtil)
# # pdf("plot.pdf",width=10,height = 8)# export pdf file
# 
# for (idx.year in (1 : length(list_year)) ){
#   
# pest <- dplyr::filter(pest.all,year==list_year[idx.year])
# 
# subData <- pest[which(pest$IS == "Neg_est") ,]
# plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
#            yLow = subData$X2.5., yHigh = subData$X97.5.,
#            type = "area", centerColour = "blue",
#            rangeColour = colourSetTransparency("blue", alpha = 0.3), ylim = c(0, 1),
#            main=paste("DENV Proportion_FOI_changed every year",p_year$Site[1],pest$year[1]),
#            cex.main=2, col.main = "blue")
# text(2.6,0.7,"Neg",col="blue")
# 
# 
# subData <- pest[which(pest$IS == "Prim_est") ,]
# plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
#            yLow = subData$X2.5., yHigh = subData$X97.5.,
#            type = "area", centerColour = "green",
#            rangeColour = colourSetTransparency("green", alpha = 0.3), newPlot = F)
# text(2.6,0.1,"Prim",col="green")
# 
# subData <- pest[which(pest$IS == "Sec_est") ,]
# plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
#            yLow = subData$X2.5., yHigh = subData$X97.5.,
#            type = "area", centerColour = "red",
#            rangeColour = colourSetTransparency("red", alpha = 0.3), newPlot = F)
# text(5,0,"Sec",col="red")
# 
# }
# 
# # dev.off()

```


## Plot the estimated proportion vs actual proportion within 95% CI


Regarding actual data, the number of samples in each age group is quite small, I gathered samples in groups of 5 years old rather than those of 1. Therefore, there are 6 groups in total: **[1-5), [5-10),[10-15), [15-20), [20-25), [25-30)**


```{r actual proportion_5yrs age,echo=FALSE, message=FALSE,fig.height=8,fig.width=12}
# CI95%
library(DescTools)
library(data.table)

pop1<- data[which(!is.na(data$AGE_MIN)&is.na(data$PanbioUnit)),]# cross out acute and ELISA samples
pop1$Site <- substr(pop1$sampleID,1,2)

##Agegroup_5years : 6 groups

pop1$AgeGroup <- floor(pop1$Age/5) + 1
pop1$AgeGroup[which(pop1$AgeGroup == 7)]<- 6
pop1$AgeGroup <- factor(
  pop1$AgeGroup,
  labels = c("[1-5)","[5-10)","[10-15)","[15-20)","[20-25)","[25-30)"))




p13CI.all=dplyr::filter(pop1,Site==paste(p_year$Site[1]))%>%group_by(AgeGroup,YEAR)%>%dplyr::count(predictedIS)%>%spread(predictedIS,n)
setnames(p13CI.all, old="Neg", new="Negative")

# Assign NA as 0:

for (idx in 3:5){
  idx.na <- which(is.na(p13CI.all[[idx]]))
  p13CI.all[[idx]][idx.na] <- 0
}

p13CI.all<- tidyr::gather(p13CI.all,"IS","n",3:5)# gather 3 variables (Neg,Prim,Secondary) into 1 variables called "IS"

p13CI.all<- p13CI.all[order(p13CI.all$YEAR,p13CI.all$AgeGroup),]# sort data by year

p13CI.all<- dplyr::mutate(p13CI.all,est=NA,lwr.ci=NA,upr.ci=NA)# create cols for importing result from multinomCI.

for ( i in seq(1,length(p13CI.all$AgeGroup),by=3)){# every 3 rows ,do....
  p13CI.all[i:(i+2), 5:7]<- MultinomCI(c(p13CI.all$n[i:(i+2)]))}


# 
# # plot
# for (idx.year in ( 1 : length(list_year))){
#   p13CI <- dplyr::filter(p13CI.all,YEAR==list_year[idx.year])
#   print(ggplot(p13CI, aes(x=AgeGroup,y=est, fill=IS,color=IS))+ geom_point()+
#           ggtitle(paste("Proportions",p_year$Site[1],p13CI$YEAR[1]))+
#           theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5))+
#           geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25, position=position_dodge(0.2)))
# 
# }

```


```{r estimated prop and actual prop in one plot,echo=FALSE,fig.height=8,fig.width=12 }
# actual proportion
p<- p13CI.all
p<- p[order(p$IS),]

# #create function for substr assigning age group as one value, this create the same age structure with p1 data frame below. This function has run in previous chunk => no need re-run in this chunk!
# 
# my_substr <- function(s){
#   if (nchar(s) == 5){
#     t <- substr(s, 4, 4)
#   }else{
#     if (nchar(s) == 6){
#       t <- substr(s, 4, 5)
#     }else{
#       t <- substr(s, 5, 6)
#     }
#   }
#   return(t)
# }

#
p$AgeGroup<- apply(p[,1],1,my_substr)
p <- p[,-4]

# estimated proportion
p1 <- pest.all[,c("AgeGroup","YEAR","IS","mean","X2.5.","X97.5.")]

colnames(p1)<- c("AgeGroup","YEAR","IS","est","lwr.ci","upr.ci")

pc.all<- rbind(data.frame(p), data.frame(p1))


pc.all$AgeGroup <- as.numeric(pc.all$AgeGroup)

#plot negatives
for ( idx.year in (1:length(list_year))){
  
  pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
  
  print(
    ggplot(pc%>%filter(IS=="Neg_est"|IS=="Negative"),
           aes(x=AgeGroup,y=est, fill=IS, color=IS))+
      geom_point()+
      xlim (1,31)+
      ylim (0,1)+
      ggtitle(paste("Neg_FOI_changed every year",p_year$Site[1],pc$YEAR[1]))+
      theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
            axis.text = element_text(face = "bold"))+
      geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 
  )
}

#plot primary
for ( idx.year in (1:length(list_year))){
  
  pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
  
  print(
    ggplot(pc%>%filter(IS=="Prim_est"|IS=="Primary"),
           aes(x=AgeGroup,y=est, fill=IS, color=IS))+
      geom_point()+
      xlim (1,31)+
      ylim (0,1)+
      ggtitle(paste("Prim_FOI_changed every year",p_year$Site[1],pc$YEAR[1]))+
      theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
            axis.text = element_text(face = "bold"))+
      geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 
  )
}

#plot secondary
for ( idx.year in (1:length(list_year))){
  
  pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
  
  print(
    ggplot(pc%>%filter(IS=="Sec_est"|IS=="Secondary"),
           aes(x=AgeGroup,y=est, fill=IS, color=IS))+
      geom_point()+
      xlim (1,31)+
      ylim (0,1)+
      ggtitle(paste("Sec_FOI_changed every year",p_year$Site[1],pc$YEAR[1]))+
      theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
            axis.text = element_text(face = "bold"))+
      geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 
  )
}



```


```{r estimated prop and actual prop_ all years in one plot,echo=FALSE,fig.height=8,fig.width=12 }
p<- p13CI.all
p<- p[order(p$IS),]

# #create function for substr assigning age group as one value, this create the same age structure with p1 data frame below. This function has run in previous chunk => no need re-run in this chunk!
# 
# my_substr <- function(s){
#   if (nchar(s) == 5){
#     t <- substr(s, 4, 4)
#   }else{
#     if (nchar(s) == 6){
#       t <- substr(s, 4, 5)
#     }else{
#       t <- substr(s, 5, 6)
#     }
#   }
#   return(t)
# }

#
p$AgeGroup<- apply(p[,1],1,my_substr)
p <- p[,-4]

# estimated proportion
p1 <- pest.all[,c("AgeGroup","YEAR","IS","mean","X2.5.","X97.5.")]

colnames(p1)<- c("AgeGroup","YEAR","IS","est","lwr.ci","upr.ci")

pc.all<- rbind(data.frame(p), data.frame(p1))
pc.all$AgeGroup <- as.numeric(pc.all$AgeGroup)

# # function to get legend from one of the plots => for nicer looking of muliplot => runned in chunk 12
# get_legend<-function(myggplot){
#     tmp <- ggplot_gtable(ggplot_build(myggplot))
#     leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
#     legend <- tmp$grobs[[leg]]
#     return(legend)
#     }

#plot negatives

neg <- list() # create empty list for input graphs in for loop
for ( idx.year in (1:length(list_year))){
    pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
    
    neg[[idx.year]] <- ggplot(pc%>%filter(IS=="Neg_est"|IS=="Negative"),
                              aes(x=AgeGroup,y=est, fill=IS, color=IS))+
        geom_point()+
        xlim (1,31)+
        ylim (0,1)+
        ggtitle(paste(pc$YEAR[1]))+
        theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
              axis.text = element_text(face = "bold"))+
        
        geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position =         position_dodge(0.5))# move CI to the left or the right a bit 
    
}

legend <- get_legend(neg[[5]])

library(grid)
library(gridExtra)
grid.arrange(neg[[1]]+theme(legend.position = "none"),
             neg[[2]]+theme(legend.position = "none"),
             neg[[3]]+theme(legend.position = "none"),
             neg[[4]]+theme(legend.position = "none"),
             neg[[5]]+theme(legend.position = "none"),
             legend, nrow=3,ncol=2,
             bottom = textGrob(paste("DENV negatives in",p_year$Site, "_FoI change every 5 years "),gp=gpar(fontsize=20,fontface="bold"))) # all plot in one page 


#plot primary
prim <- list()
for ( idx.year in (1:length(list_year))){
    
    pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
    
    prim[[idx.year]]<- ggplot(pc%>%filter(IS=="Prim_est"|IS=="Primary"),
                              aes(x=AgeGroup,y=est, fill=IS, color=IS))+
        geom_point()+
        xlim (1,31)+
        ylim (0,1)+
        ggtitle(paste(pc$YEAR[1]))+
        theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
              axis.text = element_text(face = "bold"))+
        
        geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position =         position_dodge(0.5))# move CI to the left or the right a bit 
    
}

legend <- get_legend(prim[[5]])
grid.arrange(prim[[1]]+theme(legend.position = "none"),
             prim[[2]]+theme(legend.position = "none"),
             prim[[3]]+theme(legend.position = "none"),
             prim[[4]]+theme(legend.position = "none"),
             prim[[5]]+theme(legend.position = "none"),
             legend, nrow=3,ncol=2,
             bottom = textGrob(paste("DENV primary infection in",p_year$Site, "_FoI change every 5 years "),gp=gpar(fontsize=20,fontface="bold"))) # all plot in one page 


#plot secondary
sec <- list()
for ( idx.year in (1:length(list_year))){
    
    pc <- dplyr::filter(pc.all,YEAR==list_year[idx.year])
    
    
    sec[[idx.year]] <- ggplot(pc%>%filter(IS=="Second_est"|IS=="Secondary"),
                              aes(x=AgeGroup,y=est, fill=IS, color=IS))+
        geom_point()+
        xlim (1,31)+
        ylim (0,1)+
        ggtitle(paste(pc$YEAR[1]))+
        theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
              axis.text = element_text(face = "bold"))+
        
        geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position =         position_dodge(0.5))# move CI to the left or the right a bit 
    
}

legend <- get_legend(sec[[5]])
grid.arrange(sec[[1]]+theme(legend.position = "none"),
             sec[[2]]+theme(legend.position = "none"),
             sec[[3]]+theme(legend.position = "none"),
             sec[[4]]+theme(legend.position = "none"),
             sec[[5]]+theme(legend.position = "none"),
             legend, nrow=3,ncol=2,
             bottom = textGrob(paste("DENV secondary infection in",p_year$Site, "_FoI change every 5 years "),gp=gpar(fontsize=20,fontface="bold"))) # all plot in one page 


```

---
title: "FOI_serotype specific"
author: "Phuong Huynh Thi"
date: "5 September 2018"
output: html_document
---

```{r set wd, echo=FALSE, message=FALSE}

setwd("/home/phuonght/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/FOI")

# library(plyr)
# library(caret)
# library(lattice)
# library(ggplot2)
# library(nnet)last
# library(psych)
# library(data.table)

##result from lowest AIC model:
data <- read.csv("~/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/models_modified_titers/Infecting serotype Models/PredictedIS_batch567_pred.serotype.csv")

data$YEAR <- as.factor(data$YEAR)
data$predictedIS<- ordered(data$predictedIS,levels=c("Secondary","Primary","Neg"))
data$pred.serotype<- as.factor(data$pred.serotype)

## result from lowest AIC model and homotypic responses were assigned the serotype in advance of applying infecting model
# data <- read.csv("~/Dropbox/1.SHARED_FOLDER/slides_June_2018/PMA_batch2_to_7_June2018/pop data/models/models_modified_titers/Infecting serotype Models/PredictedIS_batch567_pred.serotype_HomoAssigned.csv")

pop<- data[which(!is.na(data$AGE_MIN)&is.na(data$PanbioUnit)),]# cross out acute and ELISA samples
pop$Site <- substr(pop$sampleID,1,2)

#Agegroup_ 1year
pop$AgeGroup <-factor(as.factor(floor(pop$Age)),labels=c("[1-2)","[2-3)","[3-4)","[4-5)","[5-6)","[6-7)","[7-8)","[8-9)","[9-10)","[10-11)","[11-12)","[12-13)","[13-14)","[14-15)","[15-16)","[16-17)","[17-18)","[18-19)","[19-20)","[20-21)","[21-22)","[22-23)","[23-24)","[24-25)","[25-26)","[26-27)","[27-28)","[28-29)","[29-30)","[30,31)"))# group as  1year 1 group.

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
## Agegroup_ 2 years : 16groups

# pop$AgeGroup <-factor(as.factor(floor(pop$Age/2)+1),labels=c("[1-2)","[2-4)","[4-6)","[6-8)","[8-10)","[10-12)","[12-14)","[14-16)","[16-18)","[18-20)","[20-22)","[22-24)","[24-26)","[26-28)","[28-30)","[30-31)"))

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
##Agegroup_3years : 11 groups

# pop$AgeGroup <- floor(pop$Age/3) + 1
# pop$AgeGroup[which(pop$AgeGroup == 11)] <- 10
# pop$AgeGroup <- factor(
#   pop$AgeGroup,
#   labels = c("[1-3)","[3-6)","[6-9)","[9-12)","[12-15)","[15-18)",
#              "[18-21)","[21-24)","[24-27)","[27-31)"))


```

# Data input 
First do for one location for one year and get that working

**For each age:** 

Numbers of samples:

Number of neg samples:

Numbers of samples classified as primary / numbers of samples classified serotype specific:

Number of samples classified as secondary:


```{r data input, echo=FALSE, message=FALSE}

library(dplyr)
library(tidyr)
# spread(x,y): spread rows of col x into collums, then value of col y will fit in as rows.
#rename(new_name=old_name).

p_year=dplyr::filter(pop,Site=="HC")%>%group_by(AgeGroup,Site)%>%dplyr::count(pred.serotype)%>%spread(pred.serotype,n)
# p_year$total <- apply(p_year[,3:8],1,sum,na.rm=T)
p_year$total <-rowSums(p_year[,3:8],na.rm = T)

#create function for substr age rather than put age in order, this is useful in case of missing data in a specific age: 
my_substr <- function(s){
  if (nchar(s) == 5){
    t <- substr(s, 4, 4)
  }else{
    if (nchar(s) == 6){
      t <- substr(s, 4, 5)
    }else{
      t <- substr(s, 5, 6)
    }
  }
  return(t)
}

#
p_year$age<- apply(p_year[,1],1,my_substr)

# Assign NA as 0 because stan does not support NA value:

for (idx in 3:8){
  idx.na <- which(is.na(p_year[[idx]]))
  p_year[[idx]][idx.na] <- 0
}


# setnames(p_year, old=c("AgeGroup","1","2","3","4","Neg","Secondary","total"),new=c("AgeGroup","DV1.13","DV2.13","DV3.13","DV4.13","Neg.13","Sec.13","total.13"))


```

This gets the data in the right format for stan.

```{r data format for stan, echo=FALSE,message=FALSE}

b = length(p_year$age)
datapp<- list(a = b,
              datap=c(p_year[1:b, 7],
                      p_year[1:b, 3],
                      p_year[1:b, 4],
                      p_year[1:b, 5],
                      p_year[1:b, 6],
                      p_year[1:b, 8]),
                      veca=as.integer(p_year$age)) # numbers of neg, prim1,prim2,prim3,prim4,and sec respectively. ## Is these numbers need to be in order?

library(rstan)
# stan code has sections in it: functions, data (where you tell it what form the data will be in), 
#parameters where you say what parameters you are estimating,
#Transformed parameters where you transform these parameters to use in the model
#and the model where you specify how the data and model outcomes are linked

```

# Model code

```{r model code, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
FOI_Dengue <- '

//write function so we can sum things as sum is not built into stan


data {

// HCMC infections
int<lower=0> a;// number of age groups

int veca[a]; //vector age constitute of specific age rather than ages in order.

int datap[6,a]; ////for 2013 this will be sixgroups (neg,primary(1,2,3,4),and secondary  for all age groups)

}

parameters {

vector<lower=0, upper=1>[4] lambda;// 4 DENV serotype


}

transformed parameters {
//the probabilities of being neg, primary and secondary at each age group 
////// HCMC
// need to specify what type of data and how these are...

real pneg[a];// the probabilities of neg at each age group and year
real pprimsero1[a] ; // the probabilities of primary infection of each serotype at each age group and year
real pprimsero2[a] ;
real pprimsero3[a] ;
real pprimsero4[a] ;
real psec[a];// the probabilities of each secondary infection at each age group and year

// calculating all these probabilities
for ( ar in 1:a){

pneg[ar]=exp(-sum(lambda)*veca[ar]);// the prob of neg at each age group and year


pprimsero1[ar]=(exp(-(lambda[2]+lambda[3]+lambda[4])*veca[ar]))*(1-exp(-lambda[1]*veca[ar]));
pprimsero2[ar]=(exp(-(lambda[1]+lambda[3]+lambda[4])*veca[ar]))*(1-exp(-lambda[2]*veca[ar]));
pprimsero3[ar]=(exp(-(lambda[1]+lambda[2]+lambda[4])*veca[ar]))*(1-exp(-lambda[3]*veca[ar]));
pprimsero4[ar]=(exp(-(lambda[1]+lambda[2]+lambda[3])*veca[ar]))*(1-exp(-lambda[4]*veca[ar]));

psec[ar]= 1-pneg[ar]-pprimsero1[ar]-pprimsero2[ar]-pprimsero3[ar]-pprimsero4[ar];// the probabilities of each secondary infection at each age group and year

}
}


model {
//vector to put the model results in
vector[6] vp;

//prior on the parameter we are estimating
lambda~ beta(2,5); 

// the estimates of the things we have data for given the proportions above.

for (ar in 1:a){
vp[1]=pneg[ar];
vp[2]=pprimsero1[ar];
vp[3]=pprimsero2[ar];
vp[4]=pprimsero3[ar];
vp[5]=pprimsero4[ar];
vp[6]=psec[ar];
//likelihood thing assume multinomial
datap[1:6, ar]  ~  multinomial(vp) ;
}
}
'

```

**Some explanation**

**Rhat:** < 1.05 : model perform well

**n-eff ratio** = n-eff/(0.5 * iter * chains) < 1

**Iterations:** 1/2 Warmup : noise data=> exclude?!, 1/2 Sampling


```{r result from model, echo=FALSE, message=FALSE,warning=FALSE, include=FALSE}
# you then run using this: From this output we can quickly assess model convergence by looking at the Rhat values for each parameter. When these are at or near 1, the chains have converged. There are many other diagnostics, but this is an important one for Stan.

fit <- stan(model_code=FOI_Dengue, data=datapp, iter=6000,chains=4, cores = parallel::detectCores()) # this may be conducted via 2 steps:  stand_model() and sampling().
posterior <- rstan::extract(fit) # specify package rstan rather than tidyr
# str(posterior)
#this summarizes the parameters, gets mean,etc. of parameters and metrics of whether converged or not like Rhat and neff
foisummary <- summary(fit)
# print(foisummary$summary)

# # plot to see whether estimated parameter is convergence or not: traceplot
# plottedRows <- 1 : nrow(posterior$lambda)
# plottedRows <- which(plottedRows %% 6 == 0)
# plot(posterior$lambda[plottedRows, 4],type="l")

```

# Ploting the result of model and actual data

## Plot the posterior distribution



```{r posterior distribution of lambda, echo=FALSE,fig.height=8,fig.width=12}
#plot the posterior distribution of lambda

#create dataframe for violin plot:
p <- data.frame(lambda = as.numeric(),
                DENV = as.character())

for(a in 1:4){
  p_temp <- data.frame(lambda = posterior$lambda[ , a],
                       DENV = paste0('DENV ', a))
  p <- rbind(p, p_temp)
}

# violin plot
ggplot(p, aes(x=DENV,y=lambda)) + geom_violin()+
  ggtitle(paste("posterior lambda _ serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(hjust=0.5,face="bold",size=20,colour = "blue"),
        axis.title.x = element_blank(),
        axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl, 
                 geom="pointrange", color="red")#Add mean and standard deviation



#the estimates for the proportion in each group each age group can be accessed for each a using

#need to add data to this too to show the model fit...



```



```{r  posterior distribution of neg proportion,echo=FALSE, message=FALSE,fig.height=8,fig.width=12, warning=FALSE}

p <- data.frame(neg = as.numeric(),
                age = as.character())



for(a in 1:b){
  p_temp <- data.frame(neg = posterior$pneg[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}

# length of data frame
x_max <- length(p$age)

# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=neg)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of neg_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))



```


```{r posterior distribution of primsero1 proportion,echo=FALSE,fig.height=8,fig.width=12,warning=FALSE }

p <- data.frame(primsero1 = as.numeric(),
                age = as.character())

for(a in 1:b){
  p_temp <- data.frame(primsero1 = posterior$pprimsero1[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}

# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max ),], aes(x=age,y=primsero1)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of primsero1_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))

```


```{r posterior distribution of primsero2 proportion,echo=FALSE ,fig.height=8,fig.width=12,warning=FALSE}

p <- data.frame(primsero2 = as.numeric(),
                age = as.character())

for(a in 1:b){
  p_temp <- data.frame(primsero2 = posterior$pprimsero2[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}
# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=primsero2)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of primsero2_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))

```


```{r posterior distribution of primsero3 proportion,echo=FALSE,fig.height=8,fig.width=12,warning=FALSE }

p <- data.frame(primsero3 = as.numeric(),
                age = as.character())

for(a in 1:b){
  p_temp <- data.frame(primsero3 = posterior$pprimsero3[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}
# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=primsero3)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of primsero3_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))

```


```{r posterior distribution of primsero4 proportion,echo=FALSE,fig.height=8,fig.width=12,warning=FALSE}

p <- data.frame(primsero4 = as.numeric(),
                age = as.character())

for(a in 1:b){
  p_temp <- data.frame(primsero4 = posterior$pprimsero4[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}
# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=primsero4)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of primsero4_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))

```


```{r posterior distribution of psec proportion,echo=FALSE,fig.height=8,fig.width=12 ,warning=FALSE}

p <- data.frame(psec = as.numeric(),
                age = as.character())

for(a in 1:b){
  p_temp <- data.frame(psec = posterior$psec[ , a],
                       age = paste0(p_year$age[a]))
  p <- rbind(p, p_temp)
}
# violin plot
list.plot <- list()

for (i in 1 : 6){
list.plot[[i]] <- ggplot(p[(5*(i-1)*12000 + 1) : min((5*i*12000), x_max),], aes(x=age,y=psec)) + geom_violin()+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.title = element_blank(),
         axis.text = element_text(face = "bold"))+
  # stat_summary(fun.y=mean, geom="point", size=2, color="red")+ # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  stat_summary(fun.data=mean_sdl,
                 geom="pointrange", color="red")+#Add mean and sta
  coord_cartesian(ylim=c(0, 1))
}

library(gridExtra)
library(grid)

grid.arrange(list.plot[[1]],list.plot[[2]],list.plot[[3]],list.plot[[4]],list.plot[[5]], list.plot[[6]], ncol=3,nrow=2, top =textGrob(paste("posterior distribution of psec_ serotype specific",p_year$Site[1]),gp=gpar(fontsize=25,col = "blue")))

```


```{r posterior distribution of all,echo=FALSE,fig.height=8,fig.width=12,warning=FALSE}

p<- data.frame(prop = as.numeric(),
                age = as.character(),
                sero=as.character())


# prim<- data.frame(age = 1:29, mean = NA, hpd025 = NA, hpd975 = NA)
for(a in 1:b){
  p_neg <- data.frame(prop = posterior$pneg[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("Neg"))
  p_1 <- data.frame(prop = posterior$pprimsero1[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("DENV1"))
  p_2 <- data.frame(prop = posterior$pprimsero2[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("DENV2"))
  p_3 <- data.frame(prop = posterior$pprimsero3[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("DENV3"))
  p_4 <- data.frame(prop = posterior$pprimsero4[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("DENV4"))
 p_prim <- data.frame(prop = posterior$pprimsero1[ , a]+posterior$pprimsero2[ , a]+posterior$pprimsero3[ , a]+posterior$pprimsero4[ , a],
                age = paste0(p_year$age[a]),
                sero=paste0("Prim"))
 
  
  
  # all_p_prim <- p_1$prop + p_2$prop + p_3$prop + p_4$prop
  # 
  # prim$mean[a] <- median(all_p_prim)
  # prim$hpd025[a]<- quantile(all_p_prim, probs = 0.025)
  # prim$hpd975[a]<- quantile(all_p_prim,probs=0.975)
  p_sec <- data.frame(prop = posterior$psec[ , a],
                       age = paste0(p_year$age[a]),
                       sero=paste0("Sec"))

  p <- rbind(p, p_neg,p_prim,p_sec)
}
# violin plot

# ggplot(p, aes(x=age,y=prop,fill=sero,color=sero)) + geom_violin()+
#   ggtitle(paste("prop posterior distribution _ serotype specific",p_year$Site[1]))+
#   theme(plot.title = element_text(hjust=0.5, color = "blue"),
#         axis.title = element_blank(),
#          axis.text = element_text(face = "bold"))+
#   stat_summary(fun.y=mean, geom="point", size=2, color="red") # add mean
  # geom_boxplot(width=0.1)+# add median and quartile
  # stat_summary(fun.data=mean_sdl,
  #                geom="pointrange", color="red")+#Add mean and sta
  # coord_cartesian(ylim=c(0, 1))

library(dplyr)
prim_posterior<- dplyr::filter(p,sero=="Prim")

prim <- data.frame(mean = rep(0,b),
                   AgeGroup = rep(0,b),
                   X2.5. = rep(0,b),
                   X97.5. = rep(0,b))

for ( a in 1: b){
  prim$mean[a] <- mean(prim_posterior$prop[ ((a-1)*12000+1) : (a*12000) ])
  prim$AgeGroup[a] <- p_year$age[a]
  prim$X2.5.[a]<- quantile(prim_posterior$prop[ ((a-1)*12000+1) : (a*12000) ],probs = 0.025)
  prim$X97.5.[a]<- quantile(prim_posterior$prop[ ((a-1)*12000+1) : (a*12000) ],probs = 0.975)
}

prim$AgeGroup <- as.integer(prim$AgeGroup)


```


## Plot the estimated proportion within 95% CI


```{r estimated proportion, echo=FALSE, message=FALSE,fig.height=8,fig.width=12}

pest<-data.frame(foisummary$summary)
l_pest = length(pest$mean)
d = (l_pest-5)/6
pest<- pest[-c(1:4,l_pest),]
pest$IS <- rep(c("Neg","DENV1","DENV2","DENV3","DENV4","Sec"),c(d,d,d,d,d,d))
pest$AgeGroup<- as.integer(rep(p_year$age,6))

ggplot(pest,aes(x=AgeGroup,y=mean, fill=IS,color=IS))+ geom_point()+
  ggtitle(paste("DENV Proportion_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
        axis.text = element_text(face = "bold"))
  # geom_errorbar(aes(ymin = X2.5., ymax = X97.5.), width = .25)

# geom_errorbar(aes(ymax = y+se, ymin = y-se,x=x), width = .25)


# # grid line by ggplot 
# ggplot(pest,aes(x=AgeGroup,y=mean, fill=IS,color=IS))+ geom_line()+
#   geom_ribbon(aes(ymin=X2.5., ymax = X97.5.),alpha=0.2)+
#   ggtitle(paste("DENV Proportion_HC_FOI_serotype specific"))+
#   theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
#         axis.text = element_text(face = "bold"))
  


# plot grid line:

library(devtools)
install_github("lamhm/RUtil")
library(RUtil)
# pdf("plot.pdf",width=10,height = 8)# export pdf file

subData <- pest[which(pest$IS == "Neg") ,]
plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
           yLow = subData$X2.5., yHigh = subData$X97.5.,
           type = "area", centerColour = "blue",
           rangeColour = colourSetTransparency("blue", alpha = 0.3), ylim = c(0, 1),
           main=paste("DENV Proportion_FOI_serotype specific",p_year$Site[1]),
           cex.main=2, col.main = "blue")
text(2.6,0.7,"Neg",col="blue")


subData <- prim
plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
           yLow = subData$X2.5., yHigh = subData$X97.5.,
           type = "area", centerColour = "green",
           rangeColour = colourSetTransparency("green", alpha = 0.3), newPlot = F)
text(2.6,0.1,"Prim",col="green")

subData <- pest[which(pest$IS == "Sec") ,]
plotRanges(x = subData$AgeGroup, yCenter = subData$mean,
           yLow = subData$X2.5., yHigh = subData$X97.5.,
           type = "area", centerColour = "red",
           rangeColour = colourSetTransparency("red", alpha = 0.3), newPlot = F)
text(5,0,"Sec",col="red")

# dev.off()

```


## Plot the estimated proportion vs actual proportion within 95% CI


Regarding actual data, the number of samples in each age group is quite small, I gathered samples in groups of 5 years old rather than those of 1. Therefore, there are 6 groups in total: **[1-5), [5-10),[10-15), [15-20), [20-25), [25-30)**
 
 
 
```{r actual proportion_3yrs age , echo=FALSE, message=FALSE,fig.height=8,fig.width=12,eval=FALSE}
# CI95%
library(DescTools)
library(data.table)

pop1<- data[which(!is.na(data$AGE_MIN)&is.na(data$PanbioUnit)),]# cross out acute and ELISA samples
pop1$Site <- substr(pop1$sampleID,1,2)

##Agegroup_3years : 10 groups

pop1$AgeGroup <- floor(pop1$Age/3) + 1
pop1$AgeGroup[which(pop1$AgeGroup == 11)]<-10
pop1$AgeGroup <- factor(
  pop1$AgeGroup,
  labels = c("[1-3)","[3-6)","[6-9)","[9-12)","[12-15)","[15-18)",
             "[18-21)","[21-24)","[24-27)","[27-31)"))



p13CI=dplyr::filter(pop1,Site==paste(p_year$Site[1]))%>%group_by(AgeGroup)%>%dplyr::count(pred.serotype)%>%spread(pred.serotype,n)
setnames(p13CI, old="Neg", new="Negative")

# Assign NA as 0:

for (idx in 2:7){
  idx.na <- which(is.na(p13CI[[idx]]))
  p13CI[[idx]][idx.na] <- 0
}

p13CI<- tidyr::gather(p13CI,"IS","n",2:7)# 

p13CI<- p13CI[order(p13CI$AgeGroup),]

p13CI<- dplyr::mutate(p13CI,est=NA,lwr.ci=NA,upr.ci=NA)# create cols for importing result from multinomCI.

for ( i in seq(1,length(p13CI$AgeGroup),by=6)){
  p13CI[i:(i+5), 4:6]<- MultinomCI(c(p13CI$n[i:(i+5)]))
} # caculate proportion in each age group

# ggplot(p13CI, aes(x=AgeGroup,y=est, fill=IS,color=IS))+ geom_point()+
#   ggtitle(paste("Proportions",p_year$Site[1]))+
#   theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5))+
#    geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25, position=position_dodge(0.5))


```

 
```{r actual proportion_5yrs age,echo=FALSE, message=FALSE,fig.height=8,fig.width=12}
# CI95%
library(DescTools)
library(data.table)

pop1<- data[which(!is.na(data$AGE_MIN)&is.na(data$PanbioUnit)),]# cross out acute and ELISA samples
pop1$Site <- substr(pop1$sampleID,1,2)

##Agegroup_3years : 10 groups

pop1$AgeGroup <- floor(pop1$Age/5) + 1
pop1$AgeGroup[which(pop1$AgeGroup == 7)]<- 6
pop1$AgeGroup <- factor(
  pop1$AgeGroup,
  labels = c("[1-5)","[5-10)","[10-15)","[15-20)","[20-25)","[25-30)"))
            



p13CI=dplyr::filter(pop1,Site==paste(p_year$Site[1]))%>%group_by(AgeGroup)%>%dplyr::count(pred.serotype)%>%spread(pred.serotype,n)
setnames(p13CI, old="Neg", new="Negative")

# Assign NA as 0:

for (idx in 2:7){
  idx.na <- which(is.na(p13CI[[idx]]))
  p13CI[[idx]][idx.na] <- 0
}

p13CI<- tidyr::gather(p13CI,"IS","n",2:7)# 

p13CI<- p13CI[order(p13CI$AgeGroup),]

p13CI<- dplyr::mutate(p13CI,est=NA,lwr.ci=NA,upr.ci=NA)# create cols for importing result from multinomCI.

for ( i in seq(1,length(p13CI$AgeGroup),by=6)){
  p13CI[i:(i+5), 4:6]<- MultinomCI(c(p13CI$n[i:(i+5)]))
} # caculate proportion in each age group

# ggplot(p13CI, aes(x=AgeGroup,y=est, fill=IS,color=IS))+ geom_point()+
#   ggtitle(paste("Proportions",p_year$Site[1]))+
#   theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5))+
#    geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25, position=position_dodge(0.5))


```



```{r estimated prop and actual prop in one plot,echo=FALSE,fig.height=8,fig.width=12 }
# actual proportion
p<- p13CI
p<- p[order(p$IS),]

# #create function for substr assigning age group as one value, this create the same age structure with p1 data frame below. This function has run in previous chunk => no need re-run in this chunk!
# 
# my_substr <- function(s){
#   if (nchar(s) == 5){
#     t <- substr(s, 4, 4)
#   }else{
#     if (nchar(s) == 6){
#       t <- substr(s, 4, 5)
#     }else{
#       t <- substr(s, 5, 6)
#     }
#   }
#   return(t)
# }

#
p$AgeGroup<- apply(p[,1],1,my_substr)
p<-p[,-3]

# estimated proportion
p1 <- pest[,c("AgeGroup","IS","mean","X2.5.","X97.5.")]
colnames(p1)<- c("AgeGroup","IS","est","lwr.ci","upr.ci")

pc<- rbind(data.frame(p), data.frame(p1))


pc$AgeGroup <- as.numeric(pc$AgeGroup)



ggplot(pc%>%filter(IS=="Neg"|IS=="Negative"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("Neg_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
         axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 


ggplot(pc%>%filter(IS=="1"|IS=="DENV1"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("DENV1_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
         axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 

ggplot(pc%>%filter(IS=="2"|IS=="DENV2"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("DENV2_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5), axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit

ggplot(pc%>%filter(IS=="3"|IS=="DENV3"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("DENV3_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
         axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit

ggplot(pc%>%filter(IS=="4"|IS=="DENV4"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("DENV4_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
         axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit



ggplot(pc%>%filter(IS=="Sec"|IS=="Secondary"), aes(x=AgeGroup,y=est, fill=IS, color=IS))+ geom_point()+
  ggtitle(paste("Sec_FOI_serotype specific",p_year$Site[1]))+
  theme(plot.title = element_text(color="darkblue", size=20, face="bold", hjust = 0.5),
         axis.text = element_text(face = "bold"))+
   geom_errorbar(aes(ymax = upr.ci, ymin = lwr.ci), width = .25,position = position_dodge(0.5))# move CI to the left or the right a bit 


```


